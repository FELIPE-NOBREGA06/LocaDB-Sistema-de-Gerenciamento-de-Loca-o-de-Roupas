# LocaDB ‚Äì Sistema de Gerenciamento de Loca√ß√£o de Roupas

**Projeto de Banco de Dados ‚Äì 2025/2**

> Reposit√≥rio acad√™mico para modelagem, implementa√ß√£o e experimenta√ß√£o de conceitos de Banco de Dados usando **PostgreSQL** e **SQL** em um dom√≠nio real: uma **loja de loca√ß√£o de roupas** (trajes sociais, fantasias, vestidos de festa etc.).

---

## üìå Descri√ß√£o

Este projeto foi concebido a partir de pr√°ticas de sala de aula em cursos de **Engenharia de Sofware**. A proposta √© conduzir do **b√°sico ao avan√ßado**, sempre com **implementa√ß√£o passo a passo** e **exerc√≠cios pr√°ticos**. Voc√™ aprender√° desde a cria√ß√£o de tabelas e consultas at√© o desenvolvimento completo de um **banco relacional aplicado a um cen√°rio comercial**.

Durante as atividades utilizaremos **SQL (Structured Query Language)** e **PostgreSQL**, uma das SGBDs mais populares do mercado.

**T√≥picos trabalhados:**

* Criar, inserir, alterar e excluir dados de tabelas.
* Implementar **chaves prim√°rias** e **chaves estrangeiras**.
* Agregar dados (soma, m√©dia, m√≠nimos, m√°ximos, contagem).
* Relacionar tabelas utilizando **JOINs**.
* Criar campos **autoincremento** e **valores default**.
* Criar **fun√ß√µes**, **stored procedures**, **triggers** e **dom√≠nios**.
* Criar usu√°rios com **diferentes permiss√µes** de acesso.
* Executar **backup** e **restore** da base de dados.
* Implementar consultas com **√Ålgebra Relacional**.
* Projetar do zero usando **Modelo Entidade‚ÄëRelacionamento** ‚Üí **Modelo Conceitual** ‚Üí **Modelo L√≥gico**.
* Aplicar **Formas Normais** (1FN, 2FN, 3FN, BCNF, 4FN, 5FN).

---

## üéØ Objetivos de Aprendizagem

* Compreender e aplicar **modelagem relacional** a um dom√≠nio real.
* Escrever **SQL idiom√°tico e perform√°tico** para consultas anal√≠ticas e operacionais.
* Dominar **integridade**, **normaliza√ß√£o** e **regras de neg√≥cio** no n√≠vel do banco.
* Automatizar rotinas com **triggers**, **fun√ß√µes** e **views**.
* Gerenciar **acessos**, **pap√©is (roles)** e **privil√©gios**.
* Realizar **backup/restore** com seguran√ßa e rastreabilidade.

---

## üß© Escopo Funcional do Dom√≠nio

A loja de loca√ß√£o de roupas atende **clientes** que alugam **itens** (roupas e acess√≥rios) por **per√≠odos** espec√≠ficos. O sistema deve registrar:

* **Cat√°logo:** produtos, categorias, tamanhos, cores, estado de conserva√ß√£o.
* **Estoque:** quantidade por item/tamanho, disponibilidade por per√≠odo.
* **Clientes:** cadastro, contatos, hist√≥rico, prefer√™ncias.
* **Loca√ß√µes:** reservas, retirada, devolu√ß√£o, renova√ß√£o, cancelamentos.
* **Financeiro:** valores, descontos, multas por atraso/danos, formas de pagamento.
* **Opera√ß√£o:** funcion√°rios, hor√°rios, fluxo de aprova√ß√£o, auditoria de altera√ß√µes.

> **Regras de neg√≥cio (exemplos):**
>
> * Um item **n√£o pode** ser alocado a duas loca√ß√µes **com per√≠odos sobrepostos**.
> * Se a devolu√ß√£o ultrapassar a data/hora prevista, calcular **multa proporcional**.
> * Danos reportados geram **taxas adicionais** e **bloqueio** do item at√© manuten√ß√£o.
> * Cancelamentos obedecem **pol√≠tica parametriz√°vel** (janela, taxa, exce√ß√µes).

---

## üèóÔ∏è Modelagem (Vis√£o Geral)

**Entidades principais:** `cliente`, `funcionario`, `categoria`, `produto`, `produto_variacao` (tamanho/cor), `estoque`, `locacao`, `locacao_item`, `pagamento`, `desconto`, `multa`, `auditoria`.

**Relacionamentos essenciais:**

* `cliente` 1‚ÄîN `locacao`
* `locacao` 1‚ÄîN `locacao_item` N‚Äî1 `produto_variacao`
* `produto` 1‚ÄîN `produto_variacao` N‚Äî1 `categoria`
* `locacao` 1‚ÄîN `pagamento`

> **Observa√ß√£o:** o diagrama ER completo est√° em `/docs/er/`.

---

## üóÉÔ∏è Estrutura do Reposit√≥rio

```
LocaDB/
‚îú‚îÄ docs/
‚îÇ  ‚îú‚îÄ er/
‚îÇ  ‚îÇ  ‚îî‚îÄ locadb-er.vpd  (ou .png/.pdf)
‚îÇ  ‚îî‚îÄ dicionario-dados.md
‚îú‚îÄ sql/
‚îÇ  ‚îú‚îÄ 01_schema.sql
‚îÇ  ‚îú‚îÄ 02_constraints.sql
‚îÇ  ‚îú‚îÄ 03_seed.sql
‚îÇ  ‚îú‚îÄ 04_views.sql
‚îÇ  ‚îú‚îÄ 05_functions.sql
‚îÇ  ‚îú‚îÄ 06_triggers.sql
‚îÇ  ‚îú‚îÄ 07_roles.sql
‚îÇ  ‚îî‚îÄ 99_teardown.sql
‚îú‚îÄ scripts/
‚îÇ  ‚îú‚îÄ create_database.ps1
‚îÇ  ‚îú‚îÄ reset_database.ps1
‚îÇ  ‚îî‚îÄ backup_restore_examples.sql
‚îî‚îÄ README.md
```

---

## üîß Requisitos

* **PostgreSQL** ‚â• 14
* **psql** (CLI) ou cliente gr√°fico (pgAdmin/DBeaver)
* Acesso local ou Docker (opcional)

---

## ‚ñ∂Ô∏è Como Executar

1. **Criar a base:**

   ```bash
   psql -U postgres -c "CREATE DATABASE locadb ENCODING 'UTF8' TEMPLATE template1;"
   ```
2. **Rodar os scripts em ordem:**

   ```bash
   psql -U postgres -d locadb -f sql/01_schema.sql
   psql -U postgres -d locadb -f sql/02_constraints.sql
   psql -U postgres -d locadb -f sql/03_seed.sql
   psql -U postgres -d locadb -f sql/04_views.sql
   psql -U postgres -d locadb -f sql/05_functions.sql
   psql -U postgres -d locadb -f sql/06_triggers.sql
   psql -U postgres -d locadb -f sql/07_roles.sql
   ```
3. **(Opcional) Resetar tudo:**

   ```bash
   psql -U postgres -d locadb -f sql/99_teardown.sql
   ```

> **Dica:** Use uma transa√ß√£o por arquivo para garantir atomicidade e facilitar rollback em caso de erro.

---

## üß± Conven√ß√µes de Modelagem

* **Nomes em snake\_case** (ex.: `produto_variacao`).
* **Chaves prim√°rias** com `id` tipo `BIGSERIAL` ou `UUID`.
* **FKs** nomeadas como `fk_<tabela>__<referencia>`.
* **√çndices** com `ix_<tabela>__<coluna>`; **√≠ndices √∫nicos** com `ux_...`.
* **Restri√ß√µes** (`CHECK`) para dom√≠nios como tamanhos (`PP,P,M,G,GG`), cores etc.
* **Timestamps**: `created_at`, `updated_at` (default `now()` / triggers).

---

## üîê Seguran√ßa e Acesso

* Cria√ß√£o de **roles**: `locadb_admin`, `locadb_app`, `locadb_readonly`.
* **Privil√©gios m√≠nimos** por esquema/tabela/vis√£o.
* **RLS (Row‚ÄëLevel Security)** opcional para parti√ß√£o por filial/loja.

---

## üíæ Backup & Restore

Exemplos em `scripts/backup_restore_examples.sql`:

```sql
-- Backup (pg_dump)
-- pg_dump -U postgres -d locadb -F c -f locadb.backup

-- Restore (pg_restore)
-- pg_restore -U postgres -d locadb -c -1 locadb.backup
```

---

## üîé Consultas de Exemplo

```sql
-- Itens dispon√≠veis por per√≠odo
SELECT pv.id, p.nome, pv.tamanho, pv.cor
FROM produto_variacao pv
JOIN produto p ON p.id = pv.produto_id
WHERE NOT EXISTS (
  SELECT 1 FROM locacao_item li
  JOIN locacao l ON l.id = li.locacao_id
  WHERE li.produto_variacao_id = pv.id
    AND tstzrange(l.datahora_retirada_prevista, l.datahora_devolucao_prevista, '[)') &&
        tstzrange($1::timestamptz, $2::timestamptz, '[)')
);

-- Faturamento por m√™s
SELECT date_trunc('month', pagamento.data) AS mes,
       SUM(pagamento.valor) AS total
FROM pagamento
GROUP BY 1
ORDER BY 1;
```

---

## üß™ Testes e Qualidade

* **Dados de teste** em `03_seed.sql` com cen√°rios de reserva, atraso e dano.
* **Triggers** de auditoria em `06_triggers.sql` para rastrear updates cr√≠ticos.
* **Valida√ß√µes** via `CHECK`, `NOT NULL`, `UNIQUE` e **FKs** em cascata controlada.

---

## üõ£Ô∏è Roadmap Sugerido

* [ ] RLS por filial
* [ ] Particionamento de tabelas de hist√≥rico
* [ ] √çndices parciais para consultas de disponibilidade
* [ ] Relat√≥rios materializados (REFRESH MATERIALIZED VIEW)
* [ ] Integra√ß√£o com app externo (API apenas leitura via `dblink`/FDW)

---

## üìÑ Licen√ßa

Defina a licen√ßa do projeto (ex.: MIT). Inclua o arquivo `LICENSE` na raiz do reposit√≥rio.

---
